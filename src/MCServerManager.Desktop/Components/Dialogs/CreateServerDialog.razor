@using mcswlib.ServerStatus
@using MCServerManager.Desktop.Managers
@inject ServerStatusFactory ServerFactory
@inject SftpConnectionsManager ConnectionsManager
@inject ServerManager ServerManager

<MudDialog>
	<DialogContent>
		<MudDivider Class="mb-2"/>
		@if (_page == 0)
		{
			<MudTextField @bind-Value="@_server.Name"
			              Immediate="true"
			              Label="Server name"
			              Required="true"
			              HelperText="The display name to show on this server"
			              Placeholder="ExampleCraft"
			              TextChanged="ValidateInputs"
			              Variant="Variant.Filled"/>
			<MudStack Row="true">
				<MudTextField @bind-Value="@_server.Ip"
				              FullWidth="true"
				              Immediate="true"
				              Label="Server ip"
				              Required="true"
				              HelperText="The ip of the server"
				              Placeholder="play.examplecraft.com"
				              TextChanged="ValidateInputs"
				              Variant="Variant.Filled"/>
				<MudNumericField @bind-Value="@_server.Port"
				                 HelperText="Port of the server"
				                 Immediate="true"
				                 Label="Port"
				                 Placeholder="25565"
				                 Variant="Variant.Filled"/>
			</MudStack>
		}
		else if (_page == 1)
		{
			<MudStack Row="true">
				<MudTextField @bind-Value="_sftp.Host"
				              FullWidth="true"
				              HelperText="The host to connect"
				              Immediate="true"
				              Label="Host"
				              Placeholder="0.0.0.0"
				              Required="true"
				              TextChanged="ValidateInputs"
				              Variant="Variant.Filled"/>

				<MudNumericField @bind-Value="_sftp.Port"
				                 Label="Port"
				                 Placeholder="22"
				                 Variant="Variant.Filled"/>
			</MudStack>
			<MudTextField @bind-Value="_sftp.User"
			              HelperText="The user used to authenticate"
			              Immediate="true"
			              Label="Username"
			              Required="true"
			              TextChanged="ValidateInputs"
			              Variant="Variant.Filled"/>
			<MudTextField @bind-Value="_sftp.Password"
			              HelperText="The password used to authenticate"
			              Immediate="true"
			              InputType="InputType.Password"
			              Label="Password"
			              TextChanged="ValidateInputs"
			              Variant="Variant.Filled"/>
		}
		else if (_page == 2)
		{
			@if (_validating)
			{
				<MudStack Justify="Justify.Center" AlignItems="AlignItems.Center" Class="pt-2">
					<MudProgressCircular Indeterminate="true" Color="Color.Primary"/>
					<MudText>
						@switch (_phase)
						{
							case 0:
								@:Pinging server @_server.Ip:@_server.Port
								break;
							case 1:
								@:Connecting to @_sftp.Host as @_sftp.User
								break;
						}
					</MudText>
				</MudStack>
			}
			else
			{
				<MudStack Justify="Justify.Center" AlignItems="AlignItems.Center">
					<MudAvatar Color="Color.Primary" Size="Size.Large" Variant="Variant.Outlined" Image="@(_server.Status?.FavIcon??"icons/vanilla.png")"/>
					<MudText>@_server.Name</MudText>
					<MudText Color="Color.Success">Press <b>save</b> to add the server</MudText>
				</MudStack>
			}
		}
		@if (_error is not null)
		{
			<MudAlert Severity="Severity.Error">@_error</MudAlert>
		}
	</DialogContent>
	<DialogActions>
		<MudButton OnClick="Cancel" Disabled="_validating" Color="Color.Error">
			Cancel
		</MudButton>
		@if (_page > 0)
		{
			<MudButton OnClick="Back" Disabled="_validating">
				Back
			</MudButton>
		}
		<MudButton Color="Color.Primary" OnClick="Submit" Disabled="@(_validating || !_valid)">
			@switch (_page)
			{
				case 0:
					@:Next
					break;
				case 1:
					@:Validate
					break;
				case 2:
					@:Save
					break;
			}
		</MudButton>
	</DialogActions>
</MudDialog>