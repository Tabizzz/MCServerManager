@page "/"
@using MCServerManager.Desktop.Managers
@using MCServerManager.Desktop.Models
@using MCServerManager.Desktop.Services
@using mcswlib.ServerStatus
@using MessagePipe
@inject TaskService TaskService
@inject ServerManager ServerManager
@inject ServerStatusFactory ServerFactory
@inject SftpConnectionsManager ConnectionsManager
@inject StorageService Storage
@inject IDialogService DialogService
@inject IJSRuntime JsRuntime
@inject ISnackbar Snackbar
@inject IAsyncSubscriber<MCServer> Subscriber

@if (ServerManager.Count > 0)
{
	<MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.End">
		<MudText Typo="Typo.h5">Your servers</MudText>
		<MudButton Color="Color.Primary" OnClick="OpenCreateServerDialog">
			Add Server
		</MudButton>
	</MudStack>
	<MudDivider/>
	<MudGrid Class="pt-2">
		@foreach (var server in ServerManager.Servers)
		{
			<MudItem>
				<MudCard>
					<MudCardHeader Class="pb-1">
						<CardHeaderAvatar>
							<MudAvatar Color="Color.Secondary"
							           Variant="Variant.Outlined"
							           Image="@(server.Status?.FavIcon??"icons/vanilla.png")"/>
						</CardHeaderAvatar>
						<CardHeaderContent>
							<MudText Typo="Typo.body1">@server.Name</MudText>
							@if (server.Status is not null)
							{
								@if (server.Status.HadSuccess)
								{
									<MudStack Row="true" Justify="Justify.SpaceBetween">
										<MudText Typo="Typo.body2" Color="Color.Success">Online </MudText>
										<MudText Typo="Typo.body2" Color="Color.Success"> @(server.Status.Ping)ms</MudText> 
									</MudStack>
								}
								else
								{
									<MudText Typo="Typo.body2" Color="Color.Error">Offline</MudText>
								}
							}
							else
							{
								<MudText Typo="Typo.body2" Color="Color.Warning">Pinging...</MudText>
							}
						</CardHeaderContent>
						<CardHeaderActions>
							<MudMenu Dense="true" Icon="@Icons.Material.Filled.MoreVert">
								<MudMenuItem>
									Edit
								</MudMenuItem>
								<MudMenuItem>
									Dashboard
								</MudMenuItem>
								<MudMenuItem>
									Files
								</MudMenuItem>
								<MudMenuItem OnClick="async () => await DeleteServer(server)">
									Delete
								</MudMenuItem>
							</MudMenu>
						</CardHeaderActions>
					</MudCardHeader>
					<MudCardContent Class="pt-1">
						@if (server.Status is {New: { HadSuccess: true, OnlinePlayers: { Count: > 0 } }})
						{
							<MudAvatarGroup Max="13" Spacing="3">
								@foreach (var player in server.Status.New.OnlinePlayers)
								{
									<MudAvatar Alt="@player.Name"
									           Image="@($"https://mc-heads.net/avatar/{player.RawName}")"
									           Size="Size.Small"/>
								}
								@if (server.Status.CurrentPlayerCount - server.Status.OnlinePlayers.Count > 0)
								{
									<MudAvatar Size="Size.Small">+@(server.Status.CurrentPlayerCount - server.Status.OnlinePlayers.Count)</MudAvatar>
								}
							</MudAvatarGroup>
						}
					</MudCardContent>
				</MudCard>
			</MudItem>
		}
	</MudGrid>
}
else
{
	<MudStack Justify="Justify.Center" Class="align-center" Style="height: 100%">
		<MudIcon Size="Size.Large" Icon="@Icons.Material.Filled.ManageSearch" Style="font-size: 6rem;"/>
		<MudText>You have not servers</MudText>
		<MudButton Color="Color.Primary"
		           Variant="Variant.Filled"
		           OnClick="OpenCreateServerDialog">
			Add Server
		</MudButton>
	</MudStack>
}